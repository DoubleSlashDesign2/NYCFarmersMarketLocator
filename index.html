<!DOCTYPE html>
<!--[if IE 8]>                                  <html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->

<head>
        <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>Find a Farmers Market Near You in New York City</title>

  
  <link rel="stylesheet" href="css/foundation.css">
  

  <script src="js/vendor/custom.modernizr.js"></script>
<style>
#geo-wrapper img { max-width:none; }

@media all and (max-width: 980px) {
      #fixit {
        position:relative;
      }
   }
   
   @media all and (min-width: 980px) {
      #fixit {
        position:fixed;
		max-width:553px;
      }
   }

</style>
</head>
<body onload="initialize();">

        <div class="row">
                <div class="large-12 columns">
                        <h1>Find a Farmers Market Near You in New York City</h1>
                        <hr />
                </div>
        </div>
        
        

  <div class="row">
    <div class="large-7 columns">
            <form onsubmit="codeAddress();return false">
                <input type="text" id="inputTextAddress" placeholder="Address or Zip Code">
                        </form>
    </div>
        <div class="large-1 columns">
                <a href="#" onclick="codeAddress();return false" class="button prefix"><i class="foundicon-search"></i></a>
    </div>
        <div class="large-1 columns">
                <p style="text-align:center; font-weight:bold;">OR</p>
        </div>
        <div class="large-3 columns">
                <a href="#" onclick="lookup_location();return false" class="small button" style="width:100%;">Nearby</a>
        </div>
        </div>

                        <!-- Grid Example -->
                        <div class="row">
                                <div class="large-12 columns">
                                        <div class="panel">
                                                <h4>Farmers Markets near <span id="location"></span></h4>
                                        </div>
                                </div>
                        </div>
                        <div class="row">
                                <div class="large-5 columns" id="markets">
                                        <!-- <p style="float:right; color:#C60F13;"><i class="foundicon-clock"></i> Closed Now</p><p style="float:right; color:#457A1A;"><i class="foundicon-clock"></i> Open Now</p><p style="clear:both;">Distance from current location: XX mi</p><p>Products: Products</p><p><a href="http://www.yelp.com/biz/staten-island-ferry-whitehall-terminal-greenmarket-ny">Yelp</a></p> -->
                                        
                                </div>
                                <div class="large-7 columns">
									<div id="fixit" style="width:100%;">
                                        <div id="geo-wrapper" style="height:425px; width:100%;"  class="panel">

                                        </div>
									</div>
                                </div>
                        </div>
        

  <script>
  document.write('<script src=' +
  ('__proto__' in {} ? 'js/vendor/zepto' : 'js/vendor/jquery') +
  '.js><\/script>')
  </script>
  
  <script src="js/foundation.min.js"></script>
  <!--
<script src="js/foundation/foundation.js"></script>
<script src="js/foundation/foundation.alerts.js"></script>
<script src="js/foundation/foundation.clearing.js"></script>
<script src="js/foundation/foundation.cookie.js"></script>
<script src="js/foundation/foundation.dropdown.js"></script>
<script src="js/foundation/foundation.forms.js"></script>
<script src="js/foundation/foundation.joyride.js"></script>
<script src="js/foundation/foundation.magellan.js"></script>
<script src="js/foundation/foundation.orbit.js"></script>
<script src="js/foundation/foundation.reveal.js"></script>
<script src="js/foundation/foundation.section.js"></script>
<script src="js/foundation/foundation.tooltips.js"></script>
<script src="js/foundation/foundation.topbar.js"></script>
<script src="js/foundation/foundation.interchange.js"></script>
<script src="js/foundation/foundation.placeholder.js"></script>
<script src="js/foundation/foundation.abide.js"></script>
-->
  
  <script>
    $(document).foundation();
  </script>
    <script type="text/javascript"
 src="js/geoposition/geoPosition.js"></script>
    <script type="text/javascript"
src="http://maps.googleapis.com/maps/api/js?v=3&key=AIzaSyAufQG3-_yBGqDKE7dTf53zpqkhUKC8tao&sensor=true"></script>

<script>
google.maps.visualRefresh = true;
var geocoder;
var map;

function initialize() {
        geocoder = new google.maps.Geocoder();
        var latlng = new google.maps.LatLng(40.6700, -73.9400);
        var myOptions = {zoom:10,center:latlng, MapTypeId:google.maps.MapTypeId.ROADMAP};
        map = new google.maps.Map(document.getElementById("geo-wrapper"), myOptions);
        }
        
function codeAddress(){
        var myOptions = {MapTypeId:google.maps.MapTypeId.ROADMAP};
    map = new google.maps.Map(document.getElementById("geo-wrapper"), myOptions);
        var sAddress = document.getElementById("inputTextAddress").value;
        geocoder.geocode( { 'address': sAddress}, function(results, status) {
                if (status == google.maps.GeocoderStatus.OK) {
                                 map.setCenter(results[0].geometry.location);
								 codeLatLng(results[0].geometry.location.mb, results[0].geometry.location.nb);
                                 getResults(results[0].geometry.location.mb, results[0].geometry.location.nb);
                                 map.setZoom(14);
                                 var marker = new google.maps.Marker({map: map, title: "You are here (more or less)", position: results[0].geometry.location
});
} else {
        alert("Geocode was not successful for the following reason: " + status);
                        }
        });                
}

function supports(bool, suffix) {
var s = "Your browser ";
if (bool) {
s += "supports " + suffix + ".";
} else {
s += "does not support " + suffix + ". :(";
}
return s;
}
function lookup_location() {
geoPosition.getCurrentPosition(show_map, show_map_error);
}
function show_map(loc) {
map = new google.maps.Map(document.getElementById("geo-wrapper"), {zoom: 14, mapTypeControl:true, zoomControl: true, mapTypeId: google.maps.MapTypeId.ROADMAP});
var center = new google.maps.LatLng(loc.coords.latitude,loc.coords.longitude);
//console.log(center);
map.setCenter(center);
var marker = new google.maps.Marker({map: map, position: center, draggable: false, title: "You are here (more or less)"});
codeLatLng(center.mb, center.nb);
getResults(center.mb, center.nb);
}
function show_map_error() {
$("#geo-wrapper").html('Unable to determine your location.');
}
$(function() {
if (geoPosition.init()) {
 $("#geo-wrapper").html(supports(true, "geolocation"));
} else {
$("#geo-wrapper").html(supports(false, "geolocation"));
}
});


function codeLatLng(lat, lng) {
  var latlng = new google.maps.LatLng(lat, lng);
  geocoder.geocode({'latLng': latlng}, function(results, status) {
    if (status == google.maps.GeocoderStatus.OK) {
      if (results[1]) {
        $("#location").text(results[1].formatted_address);
      } else {
        alert('No results found');
      }
    } else {
      alert('Geocoder failed due to: ' + status);
    }
  });
}

function addMarker(location, marketName) {
	var marker = new google.maps.Marker({
	map: map,
	position: location,
	icon: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png',
	title: marketName
	});
}

function getResults(lat, lng){
 
 var url = "http://data.ny.gov/resource/n6w2-gz88.json?$where=within_circle(location_points, " + lat + "," + lng + ", 1610)"
 
 $.get( url, function( data ) {
 	//console.log( data );
 	$("#markets").empty();
 	for(var i = 0; i < data.length; i++) {
 		var current = data[i];
 		//console.log(current);
		if (current.market_link != "") {
			var website = "<p><a href=" + current.market_link + ">Website</a></p>";
		} else {
			website = '';
			}
			
 		var panel =  $('<div class="panel" id="' + current.market_name + '"><p>' + current.market_name + '</p> <p>' + current.location + '</p><p>Open ' + current.operation_hours + "<br />" + current.operation_season + '</p>' + website + '</div>');
 		$("#markets").append(panel);
 		var newMarker = new google.maps.LatLng(current.latitude, current.longitude);
 		var newMarkerTitle = current.market_name;
 		addMarker(newMarker, newMarkerTitle);
 		getUSDAResults(parseFloat(current.latitude), parseFloat(current.longitude));
 		}
 	if(data.length === 0) {
 	var emptyPanel =  $('<div class="panel" id="noMarkets"><p>Oops! I couldn\'t find a farmers market within 1 mile of your location. This app only supports searches within New York City. Please try again!</p></div>');
 		$("#markets").append(emptyPanel);
 		}
 });
 
 } 
 
function getUSDAResults(lat, lng) {
    $.ajax({
        type: "GET",
        contentType: "application/json; charset=utf-8",
        // submit a get request to the restful service mktDetail.
        url: "http://search.ams.usda.gov/farmersmarkets/v1/data.svc/locSearch?lat=" + lat + "&lng=" + lng,
        dataType: 'jsonp',
        success: function(data) {
			searchResultsHandler(data);
		},
		error : function(err, req) {
			console.log("Your browser broke!");
		}    });
}
//iterate through the JSON result object.
function searchResultsHandler(searchresults) {
    for (var key in searchresults) {
        //console.log(key);
        var results = searchresults[key];
        for (var i = 0; i < results.length; i++) {
            var result = results[i];
            for (var key in result) {
                //only do an alert on the first search result
                if (i == 0) {
                    console.log(result.id);
                }
            }
        }
    }
}
 
// function getDetails(id) {
//     $.ajax({
//         type: "GET",
//         contentType: "application/json; charset=utf-8",
//         // submit a get request to the restful service mktDetail.
//         url: "http://search.ams.usda.gov/farmersmarkets/v1/data.svc/mktDetail?id=" + id,
//         dataType: 'jsonp',
//         success: function(data) {
// 			detailResultsHandler(data, id);
// 		},
// 		error : function(err, req) {
// 			console.log("Your browser broke!");
// 		}    });
// }
// //iterate through the JSON result object.
// function detailResultsHandler(detailresults, id) {
//     for (var key in detailresults) {
//         //console.log(key);
//         var results = detailresults[key];
//         //console.log(results);
//     }


</script>

</body>
</html>