<!DOCTYPE html>
<!--[if IE 8]>                                  <html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->

<head>
        <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>Find a Farmers' Market in New York City</title>

  
  <link rel="stylesheet" href="css/foundation.css">
  

  <script src="js/vendor/custom.modernizr.js"></script>

</head>
<body onload="initialize();">

        <div class="row">
                <div class="large-12 columns">
                        <h1>Find a Farmers' Market in New York City</h1>
                        <hr />
                </div>
        </div>
        
        
        <form>
  <div class="row">
    <div class="large-7 columns">
                <input type="text" id="inputTextAddress" placeholder="Address or Zip Code">
    </div>
        <div class="large-1 columns">
                <a href="#" onclick="codeAddress();return false" class="button prefix"><i class="foundicon-search"></i></a>
    </div>
        <div class="large-1 columns">
                <p style="text-align:center; font-weight:bold;">OR</p>
        </div>
        <div class="large-3 columns">
                <a href="#" onclick="lookup_location();return false" class="small button" style="width:100%;">Nearby</a>
        </div>
        </div>
        </form>
                        <!-- Grid Example -->
                        <div class="row">
                                <div class="large-12 columns">
                                        <div class="panel">
                                                <h4>Farmers' Markets near Long Island City, New York City, Queens County, New York, 11104</h4>
                                        </div>
                                </div>
                        </div>
                        <div class="row">
                                <div class="large-5 columns" id="markets">
                                        <!-- <p style="float:right; color:#C60F13;"><i class="foundicon-clock"></i> Closed Now</p> -->
                                        
                                </div>
                                <div class="large-7 columns">
                                        <div id="geo-wrapper" class="panel">

                                        </div>
                                </div>
                        </div>
        

  <script>
  document.write('<script src=' +
  ('__proto__' in {} ? 'js/vendor/zepto' : 'js/vendor/jquery') +
  '.js><\/script>')
  </script>
  
  <script src="js/foundation.min.js"></script>
  <!--
<script src="js/foundation/foundation.js"></script>
<script src="js/foundation/foundation.alerts.js"></script>
<script src="js/foundation/foundation.clearing.js"></script>
<script src="js/foundation/foundation.cookie.js"></script>
<script src="js/foundation/foundation.dropdown.js"></script>
<script src="js/foundation/foundation.forms.js"></script>
<script src="js/foundation/foundation.joyride.js"></script>
<script src="js/foundation/foundation.magellan.js"></script>
<script src="js/foundation/foundation.orbit.js"></script>
<script src="js/foundation/foundation.reveal.js"></script>
<script src="js/foundation/foundation.section.js"></script>
<script src="js/foundation/foundation.tooltips.js"></script>
<script src="js/foundation/foundation.topbar.js"></script>
<script src="js/foundation/foundation.interchange.js"></script>
<script src="js/foundation/foundation.placeholder.js"></script>
<script src="js/foundation/foundation.abide.js"></script>
-->
  
  <script>
    $(document).foundation();
  </script>
    <script src="js/geoposition/geoPosition.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?sensor=true"></script>

<script>
var geocoder;
var map;
function initialize() {
        geocoder = new google.maps.Geocoder();
        var latlng = new google.maps.LatLng(40.6700, -73.9400);
        var myOptions = {zoom:10,center:latlng, MapTypeId:google.maps.MapTypeId.ROADMAP};
        map = new google.maps.Map(document.getElementById("geo-wrapper"), myOptions);
        $("#geo-wrapper").css({'width':'100%','height':'425px'});
        }
        
function codeAddress(){
    map = new google.maps.Map(document.getElementById("geo-wrapper"), initialize.myOptions);
        var sAddress = document.getElementById("inputTextAddress").value;
        geocoder.geocode( { 'address': sAddress}, function(results, status) {
                if (status == google.maps.GeocoderStatus.OK) {
                                 map.setCenter(results[0].geometry.location);
                                 getResults(results[0].geometry.location.lb, results[0].geometry.location.mb);
                                 map.setZoom(14);
                                 var marker = new google.maps.Marker({map: map, position: results[0].geometry.location
});
} else {
        alert("Geocode was not successful for the following reason: " + status);
                        }
        });                
}
function supports(bool, suffix) {
var s = "Your browser ";
if (bool) {
s += "supports " + suffix + ".";
} else {
s += "does not support " + suffix + ". :(";
}
return s;
}
function lookup_location() {
geoPosition.getCurrentPosition(show_map, show_map_error);
}
function show_map(loc) {
$("#geo-wrapper").css({'width':'100%','height':'425px'});
var map = new google.maps.Map(document.getElementById("geo-wrapper"), {zoom: 14, mapTypeControl:true, zoomControl: true, mapTypeId: google.maps.MapTypeId.ROADMAP});
var center = new google.maps.LatLng(loc.coords.latitude,loc.coords.longitude);
//console.log(center);
map.setCenter(center);
var marker = new google.maps.Marker({map: map, position: center, draggable: false, title: "You are here (more or less)"});
getResults(center.lb, center.mb);
}
function show_map_error() {
$("#geo-wrapper").html('Unable to determine your location.');
}
$(function() {
if (geoPosition.init()) {
 $("#geo-wrapper").html(supports(true, "geolocation"));
} else {
$("#geo-wrapper").html(supports(false, "geolocation"));
}
});

function addMarker(location, title) {
	marker = new google.maps.Marker({
	position: location,
	map: map,
	title: title
	});
}

function getResults(lat, lng){
 
 var url = "http://data.ny.gov/resource/n6w2-gz88.json?$where=within_circle(location_points, " + lat + "," + lng + ", 1610)"
 
 $.get( url, function( data ) {
 	//console.log( data );
 	for(var i = 0; i < data.length; i++) {
 		var current = data[i];
 		console.log(current);
 		var panel =  $('<div class="panel" id="' + current.market_name + '"><p style="width:60%; float:left;">' + current.market_name + '</p> <p style="float:right; color:#457A1A;"><i class="foundicon-clock"></i> Open Now</p><p style="clear:both;">Distance from current location: XX mi</p><p>' + current.location + '</p><p>Open ' + current.operation_hours + " " + current.operation_season + '</p><p>Products: Products </p><p><a href="http://www.grownyc.org/greenmarket-site/manhattan/si-ferry-greenmarket">Website</a> | <a href="http://www.yelp.com/biz/staten-island-ferry-whitehall-terminal-greenmarket-ny">Yelp</a></p></div>');
 		$("#markets").append(panel);
 		var newMarker = new google.maps.LatLng(current.latitude, current.longitude);
 		var newMarkerTitle = current.market_name;
 		addMarker(newMarker);
 		}
 });
 
 } 
 
// function getDetails(id) {
//     $.ajax({
//         type: "GET",
//         contentType: "application/json; charset=utf-8",
//         // submit a get request to the restful service mktDetail.
//         url: "http://search.ams.usda.gov/farmersmarkets/v1/data.svc/mktDetail?id=" + id,
//         dataType: 'jsonp',
//         success: function(data) {
// 			detailResultsHandler(data, id);
// 		},
// 		error : function(err, req) {
// 			console.log("Your browser broke!");
// 		}    });
// }
// //iterate through the JSON result object.
// function detailResultsHandler(detailresults, id) {
//     for (var key in detailresults) {
//         //console.log(key);
//         var results = detailresults[key];
//         //console.log(results);
//     }

</script>

</body>
</html>